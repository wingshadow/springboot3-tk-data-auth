<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hawk.generator.mapper.GenTableColumnMapper">
    <resultMap type="com.hawk.generator.entity.GenTableColumn" id="GenTableColumnResult">
        <id property="columnId" column="column_id"/>
        <result property="tableId" column="table_id"/>
        <result property="columnName" column="column_name"/>
        <result property="columnComment" column="column_comment"/>
        <result property="columnType" column="column_type"/>
        <result property="javaType" column="java_type"/>
        <result property="javaField" column="java_field"/>
        <result property="isPk" column="is_pk"/>
        <result property="isIncrement" column="is_increment"/>
        <result property="isRequired" column="is_required"/>
        <result property="isInsert" column="is_insert"/>
        <result property="isEdit" column="is_edit"/>
        <result property="isList" column="is_list"/>
        <result property="isQuery" column="is_query"/>
        <result property="queryType" column="query_type"/>
        <result property="htmlType" column="html_type"/>
        <result property="dictType" column="dict_type"/>
        <result property="sort" column="sort"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <select id="selectDbTableColumnsByName" parameterType="String" resultMap="GenTableColumnResult">
        <if test="@com.hawk.framework.helper.DataBaseHelper@isMySql()">
            select column_name,
            (case when (is_nullable = 'no' <![CDATA[ && ]]> column_key != 'PRI') then '1' else null end) as is_required,
            (case when column_key = 'PRI' then '1' else '0' end) as is_pk,
            ordinal_position as sort,
            column_comment,
            (case when extra = 'auto_increment' then '1' else '0' end) as is_increment,
            column_type
            from information_schema.columns where table_schema = (select database()) and table_name = (#{tableName})
            order by ordinal_position
        </if>
        <if test="@com.hawk.framework.helper.DataBaseHelper@isOracle()">
            select lower(temp.column_name) as column_name,
            (case when (temp.nullable = 'N' and temp.constraint_type != 'P') then '1' else null end) as is_required,
            (case when temp.constraint_type = 'P' then '1' else '0' end) as is_pk,
            temp.column_id as sort,
            temp.comments as column_comment,
            (case when temp.constraint_type = 'P' then '1' else '0' end) as is_increment,
            lower(temp.data_type) as column_type
            from (
            select col.column_id, col.column_name,col.nullable, col.data_type, colc.comments, uc.constraint_type,
            row_number()
            over (partition by col.column_name order by uc.constraint_type desc) as row_flg
            from user_tab_columns col
            left join user_col_comments colc on colc.table_name = col.table_name and colc.column_name = col.column_name
            left join user_cons_columns ucc on ucc.table_name = col.table_name and ucc.column_name = col.column_name
            left join user_constraints uc on uc.constraint_name = ucc.constraint_name
            where col.table_name = upper(#{tableName})
            ) temp
            WHERE temp.row_flg = 1
            ORDER BY temp.column_id
        </if>
        <if test="@com.hawk.framework.helper.DataBaseHelper@isPostgerSql()">
            SELECT
            a.attname AS column_name,
            (CASE WHEN NOT a.attnotnull THEN 1 ELSE 0 END) AS is_required, -- 是否允许 NULL (反转 attnotnull，YES 转为 1，NO 转为 0)
            (CASE
            WHEN (SELECT i.indisprimary
            FROM pg_index i
            WHERE i.indrelid = a.attrelid
            AND a.attnum = ANY (i.indkey)) THEN 1
            ELSE 0
            END) AS is_pk, -- 是否是主键 (YES 转为 1，NO 转为 0)
            a.attnum AS sort, -- 列在表中的顺序
            col_description(a.attrelid, a.attnum) AS column_comment, -- 列注释
            (CASE WHEN a.attidentity != '' THEN 1 ELSE 0 END) AS is_increment, -- 是否自增 (YES 转为 1，NO 转为 0)
            format_type(a.atttypid, a.atttypmod) AS column_type -- 列数据类型
            FROM
            pg_attribute a
            JOIN
            pg_class c ON a.attrelid = c.oid
            JOIN
            pg_namespace n ON c.relnamespace = n.oid
            WHERE
            c.relname = (#{tableName}) -- 替换为目标表名
            AND n.nspname = CURRENT_SCHEMA -- 替换为目标模式
            AND a.attnum > 0 -- 排除系统字段
            AND NOT a.attisdropped; -- 排除已删除的列

        </if>
        <if test="@com.hawk.framework.helper.DataBaseHelper@isSqlServer()">
            SELECT
            cast(A.NAME as nvarchar) as column_name,
            cast(B.NAME as nvarchar) + (case when B.NAME = 'numeric' then '(' + cast(A.prec as nvarchar) + ',' +
            cast(A.scale as nvarchar) + ')' else '' end) as column_type,
            cast(G.[VALUE] as nvarchar) as column_comment,
            (SELECT 1 FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE Z WHERE TABLE_NAME = D.NAME and A.NAME = Z.column_name )
            as is_pk,
            colorder as sort
            FROM SYSCOLUMNS A
            LEFT JOIN SYSTYPES B ON A.XTYPE = B.XUSERTYPE
            INNER JOIN SYSOBJECTS D ON A.ID = D.ID AND D.XTYPE='U' AND D.NAME != 'DTPROPERTIES'
            LEFT JOIN SYS.EXTENDED_PROPERTIES G ON A.ID = G.MAJOR_ID AND A.COLID = G.MINOR_ID
            LEFT JOIN SYS.EXTENDED_PROPERTIES F ON D.ID = F.MAJOR_ID AND F.MINOR_ID = 0
            WHERE D.NAME = #{tableName}
            ORDER BY A.COLORDER
        </if>
    </select>
</mapper>
